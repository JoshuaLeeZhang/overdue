<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Desktop Agent</title>
  <style>
    body {
      font-family: system-ui, sans-serif;
      max-width: 800px;
      margin: 2rem auto;
      padding: 0 1rem;
    }
    button {
      font-size: 1rem;
      padding: 0.5rem 1rem;
      cursor: pointer;
    }
    #logs {
      margin-top: 1rem;
      padding: 1rem;
      background: #f5f5f5;
      border-radius: 6px;
      min-height: 120px;
      white-space: pre-wrap;
      font-family: monospace;
      font-size: 0.9rem;
    }
    #result {
      margin-top: 1rem;
      padding: 1rem;
      background: #e8f5e9;
      border-radius: 6px;
      display: none;
    }
    #result.visible {
      display: block;
    }
    #result h3 { margin-top: 0; }
    #result pre { overflow: auto; white-space: pre-wrap; }
  </style>
</head>
<body>
  <h1>Desktop Agent</h1>
  <p>
    <input type="text" id="agent-input" placeholder="e.g. Go to example.com and extract the page (optional)" style="width: 100%; max-width: 500px; padding: 0.4rem; margin-right: 0.5rem;" />
    <button id="run">Run agent</button>
  </p>
  <div id="logs"></div>
  <div id="result">
    <h3>Extracted content</h3>
    <p><strong>Title:</strong> <span id="result-title"></span></p>
    <p><strong>Text:</strong></p>
    <pre id="result-text"></pre>
  </div>

  <script>
    const logsEl = document.getElementById('logs');
    const resultEl = document.getElementById('result');
    const resultTitle = document.getElementById('result-title');
    const resultText = document.getElementById('result-text');

    const wsScheme = location.protocol === 'https:' ? 'wss:' : 'ws:';
    const wsUrl = `${wsScheme}//${location.host}`;
    let ws;

    function connect() {
      ws = new WebSocket(wsUrl);
      ws.onmessage = (e) => {
        const msg = JSON.parse(e.data);
        if (msg.type === 'log') {
          logsEl.textContent += msg.payload + '\n';
          logsEl.scrollTop = logsEl.scrollHeight;
        } else if (msg.type === 'result') {
          resultTitle.textContent = msg.payload.title || '';
          resultText.textContent = msg.payload.text || '';
          resultEl.classList.add('visible');
        } else if (msg.type === 'end') {
          logsEl.textContent += '\n(Agent finished)\n';
        }
      };
      ws.onclose = () => {
        setTimeout(connect, 2000);
      };
    }
    connect();

    document.getElementById('run').onclick = () => {
      logsEl.textContent = '';
      resultEl.classList.remove('visible');
      const input = document.getElementById('agent-input').value.trim();
      const body = input ? { input } : {};
      fetch('/run-agent', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(body),
      })
        .then((r) => r.json())
        .then((data) => {
          if (data.error) logsEl.textContent += 'Error: ' + data.error + '\n';
          else if (data.finalOutput !== undefined) {
            resultTitle.textContent = 'Agent';
            resultText.textContent = data.finalOutput;
            resultEl.classList.add('visible');
            logsEl.textContent += 'Done.\n';
          } else logsEl.textContent += 'Agent started.\n';
        })
        .catch((err) => { logsEl.textContent += 'Error: ' + err.message + '\n'; });
    };
  </script>
</body>
</html>
